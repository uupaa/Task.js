var e=null,f=this.self||global;function g(a,c,b){b=b||{};var d=c instanceof g,l=b.tick||e,m=b.name||"anonymous";b=b.buffer||(d?c.buffer():[]);this.c=m+"@"+ ++h;this.a={d:l,buffer:b,e:c,b:d,g:a,f:0,i:0,h:0,message:"Error: "+this.c,state:""};j[this.c]=this;a||k(this,"init")}
function k(a,c){var b=a.a;if(""===b.state){switch(c){case "init":b.state=n(b);break;case "pass":++b.i;b.state=n(b);break;case "miss":++b.h;b.state=n(b);break;case "exit":b.state="exit"}b.state&&(b.b?(b.e.message(b.message),b.e[b.state]()):b.e("pass"===b.state?e:Error(b.message),a.a.buffer),delete j[a.c],a.a.d=e,a.a.buffer=e,a.a.e=e)}return a}function n(a){return a.h>a.f?"miss":a.i>=a.g?"pass":""}
function q(a){function c(a,b,c,d){var p=new g(1,c,{name:b});if(b in a.j)try{a.j[b](p,a.k),d&&q(a)}catch(s){p.done(s)}else isFinite(b)&&setTimeout(function(){p.pass();d&&q(a)},parseInt(b,10)|0)}if(!a.b.isFinished()){var b=a.l[a.index++];if(1===b.length)c(a,b[0],a.b,!0);else{var d=new g(b.length,function(b){a.b.done(b);b||q(a)},{buffer:a.b.buffer()});b.forEach(function(b){c(a,b,d,!1)})}}}var t="process"in f,j={},h=0;g.repository="https://github.com/uupaa/Task.js/";g.name="Task";
g.prototype={constructor:g,push:function(a){this.a.buffer&&this.a.buffer.push(a);return this},set:function(a,c){this.a.buffer&&(this.a.buffer[a]=c);return this},done:function(a){var c=a instanceof Error;c&&this.message(a.message);return c?this.miss():this.pass()},pass:function(){this.a.d&&this.a.d(this.c);return k(this,"pass")},miss:function(){this.a.d&&this.a.d(this.c);return k(this,"miss")},exit:function(){return k(this,"exit")},buffer:function(){return this.a.buffer},extend:function(a){this.a.g+=
a;return this},message:function(a){this.a.message=a.message||a;return this},missable:function(a){this.a.f+=a;return this},isFinished:function(){return""!==this.a.state}};g.dump=function(a){var c={},b;for(b in j)if(!a||a===b.split("@")[0]){var d=j[b].a;c[b]={junction:d.b,taskCount:d.g,missableCount:d.f,passedCount:d.i,missedCount:d.h,state:d.state}}return JSON.parse(JSON.stringify(c))};g.drop=function(){j={};h=0};g.flatten=function(a){return Array.prototype.concat.apply([],a)};g.arraynize=function(a){return Array.prototype.slice.call(a)};
g.objectize=function(a){return Object.keys(a).reduce(function(c,b){c[b]=a[b];return c},{})};g.run=function(a,c,b,d){d=d||{};var l=d.arg||e,m=d.name||"Task.run",r=d.buffer||(b instanceof g?b.buffer():[]);d=e;d=a?JSON.parse("[["+a.replace(/\+/g,",").replace(/>/g,"],[").replace(/(\w+)/g,'"$1"')+"]]"):JSON.parse('[["'+Object.keys(c).join('"],["')+'"]]');a=new g(d.length,b,{name:m,buffer:r});q({b:a,l:d,index:0,j:c,k:l});return a};t&&(module.exports=g);f.Task?f.Task_=g:f.Task=g;
