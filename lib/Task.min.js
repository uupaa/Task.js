var e=null,f=this.self||global;function g(a,d,b){b=b||{};var c=d instanceof g,l=b.tick||e,m=b.name||"anonymous";b=b.buffer||(c?d.buffer():[]);this.d=m+"@"+ ++h;this.a={c:l,buffer:b,e:d,b:c,h:a,f:0,i:0,g:0,message:"",state:""};j[this.d]=this;!a&&k(this,"init")}
function k(a,d){var b=a.a;if(""===b.state){switch(d){case "init":b.state=n(b);break;case "pass":++b.i;b.state=n(b);break;case "miss":++b.g;b.state=n(b);break;case "exit":b.state="exit"}b.state&&(b.b?(b.e.message(b.message),b.e[b.state]()):b.e("pass"===b.state?e:Error(b.message),a.a.buffer),delete j[a.d],a.a.c=e,a.a.buffer=e,a.a.e=e)}return a}function n(a){return a.g>a.f?"miss":a.g+a.i>=a.h?"pass":""}
function q(a){function d(a,b,c,d){var p=new g(1,c,{name:b});if(b in a.j)try{a.j[b](p,a.k),d&&q(a)}catch(s){p.done(s)}else isFinite(b)&&setTimeout(function(){p.pass();d&&q(a)},parseInt(b)|0)}if(!a.b.isFinished()){var b=a.l[a.index++];if(1===b.length)d(a,b[0],a.b,!0);else{var c=new g(b.length,function(b){a.b.done(b);b||q(a)},{buffer:a.b.buffer()});b.forEach(function(b){d(a,b,c,!1)})}}}var t="process"in f,j={},h=0;g.repository="https://github.com/uupaa/Task.js/";g.name="Task";
g.prototype={constructor:g,push:function(a){this.a.buffer&&this.a.buffer.push(a);return this},set:function(a,d){this.a.buffer&&(this.a.buffer[a]=d);return this},done:function(a){a instanceof Error&&this.message(a.message);return a?this.miss():this.pass()},pass:function(){this.a.c&&this.a.c(this.d);return k(this,"pass")},miss:function(){this.a.c&&this.a.c(this.d);return k(this,"miss")},exit:function(){return k(this,"exit")},buffer:function(){return this.a.buffer},extend:function(a){this.a.h+=a;return this},
message:function(a){this.a.message=a;return this},missable:function(a){this.a.f+=a;return this},isFinished:function(){return""!==this.a.state}};g.dump=function(a){var d={},b;for(b in j)if(!a||a===b.split("@")[0]){var c=j[b].a;d[b]={junction:c.b,taskCount:c.h,missableCount:c.f,passedCount:c.i,missedCount:c.g,state:c.state}}return JSON.parse(JSON.stringify(d))};g.drop=function(){j={};h=0};g.flatten=function(a){return Array.prototype.concat.apply([],a)};g.arraynize=function(a){return Array.prototype.slice.call(a)};
g.objectize=function(a){return Object.keys(a).reduce(function(d,b){d[b]=a[b];return d},{})};g.run=function(a,d,b,c){c=c||{};var l=c.arg||e,m=c.name||"Task.run",r=c.buffer||(b instanceof g?b.buffer():[]);c=e;c=a?JSON.parse("[["+a.replace(/\+/g,",").replace(/>/g,"],[").replace(/(\w+)/g,'"$1"')+"]]"):JSON.parse('[["'+Object.keys(d).join('"],["')+'"]]');a=new g(c.length,b,{name:m,buffer:r});q({b:a,l:c,index:0,j:d,k:l});return a};t&&(module.exports=g);f.Task?f.Task_=g:f.Task=g;
