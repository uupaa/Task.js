var e=null,g=this.self||global;function j(a,c,b){b=b||{};var d=c instanceof j,f=b.tick||e,h=b.name||"anonymous";b=b.buffer||(d?c.buffer():[]);this.c=h+"@"+ ++k;this.a={b:f,buffer:b,d:c,i:d,g:a,e:0,h:0,f:0,message:"",state:""};l[this.c]=this;!a&&m(this,"init")}
function m(a,c){var b=a.a;if(""===b.state){switch(c){case "init":b.state=n(b);break;case "pass":++b.h;b.state=n(b);break;case "miss":++b.f;b.state=n(b);break;case "exit":b.state="exit"}b.state&&(b.i?(b.d.message(b.message),b.d[b.state]()):b.d("pass"===b.state?e:Error(b.message),a.a.buffer),delete l[a.c],a.a.b=e,a.a.buffer=e,a.a.d=e)}return a}function n(a){return a.f>a.e?"miss":a.f+a.h>=a.g?"pass":""}
function p(a,c,b,d,f){if(!a.isFinished()){var h=c[b],r=new j(h.length,function(q){q?a.message(q.message).miss():(a.pass(),p(a,c,b+1,d,f))},{buffer:a.buffer()});h.forEach(function(a){var b=new j(1,r,{name:a});if(a in d)try{d[a](b,f)}catch(c){b.message(c.message).miss()}else isFinite(a)&&setTimeout(function(){b.pass()},parseInt(a)||0)})}}var s="process"in g,l={},k=0;j.repository="https://github.com/uupaa/Task.js/";j.name="Task";
j.prototype={constructor:j,push:function(a){this.a.buffer&&this.a.buffer.push(a);return this},set:function(a,c){this.a.buffer&&(this.a.buffer[a]=c);return this},pass:function(){this.a.b&&this.a.b(this.c);return m(this,"pass")},miss:function(){this.a.b&&this.a.b(this.c);return m(this,"miss")},exit:function(){return m(this,"exit")},buffer:function(){return this.a.buffer},extend:function(a){this.a.g+=a;return this},message:function(a){this.a.message=a;return this},missable:function(a){this.a.e+=a;return this},
isFinished:function(){return""!==this.a.state}};j.dump=function(a){var c={},b;for(b in l)if(!a||a===b.split("@")[0]){var d=l[b].a;c[b]={junction:d.i,taskCount:d.g,missableCount:d.e,passedCount:d.h,missedCount:d.f,state:d.state}}return JSON.parse(JSON.stringify(c))};j.drop=function(){l={};k=0};j.flatten=function(a){return Array.prototype.concat.apply([],a)};j.arraynize=function(a){return Array.prototype.slice.call(a)};
j.objectize=function(a){return Object.keys(a).reduce(function(c,b){c[b]=a[b];return c},{})};j.run=function(a,c,b,d){var f=e,f=a?JSON.parse("[["+a.replace(/\+/g,",").replace(/>/g,"],[").replace(/(\w+)/g,'"$1"')+"]]"):JSON.parse('[["'+Object.keys(c).join('"],["')+'"]]');d=d||{};a=d.args||{};var h=d.name||"Task.run";d=d.buffer||(b instanceof j?b.buffer():[]);b=new j(f.length,b,{name:h,buffer:d});p(b,f,0,c,a);return b};s&&(module.exports=j);g.Task?g.Task_=j:g.Task=j;
