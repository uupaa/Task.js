var e=null,h=this.self||global;function j(a,c,b){b=b||{};var d=c instanceof j,f=b.tick||e,g=b.name||"anonymous";b=b.buffer||(d?c.buffer():[]);this.c=g+"@"+ ++k;this.a={b:f,buffer:b,g:c,i:d,f:a,d:0,h:0,e:0,message:"",state:""};l[this.c]=this;!a&&m(this,"init")}
function m(a,c){var b=a.a;if(""===b.state){switch(c){case "init":b.state=n(b);break;case "pass":++b.h;b.state=n(b);break;case "miss":++b.e;b.state=n(b);break;case "exit":b.state="exit"}if(b.state){if(b.i)b.g[b.state]();else b.g("pass"===b.state?e:Error(b.message),a.a.buffer,a);delete l[a.c];a.a.b=e;a.a.buffer=e;a.a.g=e}}return a}function n(a){return a.e>a.d?"miss":a.e+a.h>=a.f?"pass":""}
function p(a,c,b,d,f){if(!a.isFinished()){var g=c[f],r=new j(g.length,function(q){q?a.miss():(a.pass(),p(a,c,b,d,f+1))},{buffer:a.buffer()});g.forEach(function(c){var f=new j(1,r,{name:c});if(c in b)try{b[c](f,d)}catch(g){a.message(g.message),f.miss()}else isFinite(c)&&setTimeout(function(){f.pass()},parseInt(c)||0)})}return a}var s="process"in h,l={},k=0;j.repository="https://github.com/uupaa/Task.js/";j.name="Task";
j.prototype={constructor:j,push:function(a){this.a.buffer&&this.a.buffer.push(a);return this},set:function(a,c){this.a.buffer&&(this.a.buffer[a]=c);return this},pass:function(){this.a.b&&this.a.b(this.c);return m(this,"pass")},miss:function(){this.a.b&&this.a.b(this.c);return m(this,"miss")},exit:function(){return m(this,"exit")},buffer:function(){return this.a.buffer},extend:function(a){this.a.f+=a;return this},message:function(a){this.a.message=a;return this},missable:function(a){this.a.d+=a;return this},
isFinished:function(){return""!==this.a.state}};j.dump=function(a){var c={},b;for(b in l)if(!a||a===b.split("@")[0]){var d=l[b].a;c[b]={junction:d.i,taskCount:d.f,missableCount:d.d,passedCount:d.h,missedCount:d.e,state:d.state}}return JSON.parse(JSON.stringify(c))};j.drop=function(){l={};k=0};j.flatten=function(a){return Array.prototype.concat.apply([],a)};j.arraynize=function(a){return Array.prototype.slice.call(a)};
j.objectize=function(a){return Object.keys(a).reduce(function(c,b){c[b]=a[b];return c},{})};j.run=function(a,c,b,d){var f=e,f=a?JSON.parse("[["+a.replace(/\s+/g,"").replace(/\+/g,",").replace(/>/g,"],[").replace(/(\w+)/g,'"$1"')+"]]"):JSON.parse('[["'+Object.keys(c).join('"],["')+'"]]');d=d||{};a=d.args||{};var g=d.name||"Task.run";d=d.buffer||(b instanceof j?b.buffer():[]);b=new j(f.length,b,{name:g,buffer:d});return p(b,f,c,a,0)};s&&(module.exports=j);h.Task?h.Task_=j:h.Task=j;
