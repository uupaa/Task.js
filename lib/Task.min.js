var d=this.self||global;function e(a,b,c,h){this.a={d:b,e:"",h:a,c:h,f:0,i:"",j:0,g:0,state:"",b:[]};c&&(this.a.e=c+"_"+(Math.random()+"").slice(2),f[this.a.e]=this);g(this.a,"init")}function j(a,b,c,h){""===a.state&&void 0!==b&&(c?(a.b[c]=b,h||a.b.push(b)):a.b.push(b))}
function g(a,b){if(""===a.state){switch(b){case "init":a.state=k(a);break;case "pass":++a.j;a.state=k(a);break;case "miss":++a.g;a.state=k(a);break;case "exit":a.state="exit"}if(a.state){if(a.d instanceof e)a.d[a.state](a.b);else a.d("pass"===a.state?null:Error(a.i),a.b);a.e&&delete f[a.e];a.b=[];a.d=a.c=null}}}function k(a){return a.g>a.f?"miss":a.g+a.j>=a.h?"pass":""}var l="process"in d,f={};e.name="Task";e.repository="https://github.com/uupaa/Task.js/";
e.prototype={constructor:e,pass:function(a,b,c){this.a.c&&this.a.c();j(this.a,a,b,c);g(this.a,"pass");return this},miss:function(a,b,c){this.a.c&&this.a.c();j(this.a,a,b,c);g(this.a,"miss");return this},exit:function(a,b,c){j(this.a,a,b,c);g(this.a,"exit");return this},extend:function(a){this.a.h+=a;return this},message:function(a){this.a.i=a+"";return this},missable:function(a){this.a.f+=a;return this},isFinished:function(){return""!==this.a.state}};
e.dump=function(a){var b=[];if(a)Object.keys(f).forEach(function(c){a===c.split("_")[0]&&b.push(JSON.stringify(f[c].a,null,4))});else for(var c in f)b.push(JSON.stringify(f[c].a,null,4));return b+""};e.clear=function(){f={}};e.flatten=function(a){return Array.prototype.concat.apply([],a)};l&&(module.exports=e);d.Task?d.Task_=e:d.Task=e;
